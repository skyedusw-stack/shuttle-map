<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>셔틀버스 정차지 검색</title>

    <!-- Kakao Maps API (지연 로드용: autoload=false 필수) -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=e0ed84b38bd53c1a90ebfc15b786cad4&libraries=services&autoload=false"></script>

    <style>
        body {
            font-family: "Noto Sans KR", sans-serif;
            margin: 0;
            padding: 20px;
            background: #fafafa;
        }
        h1 {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 20px;
        }
        #userAddress {
            width: 70%;
            padding: 14px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 16px;
        }
        #searchBtn {
            padding: 14px 24px;
            font-size: 16px;
            background: #172C8D;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        #searchBtn:hover {
            background: #0f1d63;
        }
        #map {
            width: 100%;
            height: 400px;
            margin-top: 20px;
            border-radius: 12px;
        }
        #result {
            margin-top: 20px;
            padding: 16px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            font-size: 15px;
            line-height: 1.6;
        }
    </style>
</head>

<body>
    <h1>셔틀버스 정차지 검색</h1>

    <input id="userAddress" type="text" placeholder="주소를 입력하세요" />
    <button id="searchBtn" onclick="searchAddress()">검색</button>

    <div id="map"></div>
    <div id="result"></div>

    <script>
        // ===== 지도 변수 선언 =====
        let map, geocoder, userMarker, circle;

        // ===== 카카오맵 로드 후 실행할 초기화 함수 =====
        function initKakao() {
            geocoder = new kakao.maps.services.Geocoder();

            map = new kakao.maps.Map(document.getElementById("map"), {
                center: new kakao.maps.LatLng(37.285, 127.01),
                level: 6
            });
        }

        // 창 로드 후 Kakao API 비동기 로드
        window.onload = function () {
            kakao.maps.load(initKakao);
        };

        // ===== CSV 구글 시트 URL =====
        const CSV_URL =
            "https://docs.google.com/spreadsheets/d/e/2PACX-1vRKhfocVUTUBOZugwcAROeWqHAZAGA-DzpoE-t8KE3Ahtje4qIvPWu31m5zPfRbU6P2D7Kfw31z03V2/pub?output=csv";

        // ===== CSV 불러오기 =====
        async function loadStops() {
            const res = await fetch(CSV_URL);
            const text = await res.text();
            const rows = text.trim().split("\n").slice(1);

            return rows.map(r => {
                const [address, name] = r.split(",");
                return {
                    address: address.trim(),
                    name: name.trim()
                };
            });
        }

        // ===== 주소 → 좌표 변환 =====
        function getCoords(address) {
            return new Promise(resolve => {
                geocoder.addressSearch(address, function (result, status) {
                    if (status === kakao.maps.services.Status.OK) {
                        resolve({
                            lat: parseFloat(result[0].y),
                            lng: parseFloat(result[0].x)
                        });
                    } else resolve(null);
                });
            });
        }

        // ===== 두 점 사이 거리 계산(단위: km) =====
        function getDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;

            const a =
                Math.sin(dLat / 2) ** 2 +
                Math.cos(lat1 * Math.PI / 180) *
                Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) ** 2;

            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        // ===== 검색 실행 함수 =====
        async function searchAddress() {
            const input = document.getElementById("userAddress").value.trim();
            if (!input) return alert("주소를 입력해주세요.");

            // 사용자 입력 주소 좌표 변환
            const userPos = await getCoords(input);
            if (!userPos) return alert("주소를 찾을 수 없습니다.");

            const userLatLng = new kakao.maps.LatLng(userPos.lat, userPos.lng);
            map.setCenter(userLatLng);

            // 사용자 마커 표시
            if (userMarker) userMarker.setMap(null);
            userMarker = new kakao.maps.Marker({
                position: userLatLng,
                map: map
            });

            // 반경 5km 표시 원
            if (circle) circle.setMap(null);
            circle = new kakao.maps.Circle({
                center: userLatLng,
                radius: 5000,   // 5km
                strokeWeight: 2,
                strokeColor: "#172C8D",
                strokeOpacity: 0.8,
                fillColor: "#A3B8FF",
                fillOpacity: 0.2
            });
            circle.setMap(map);

            // CSV 정류장 데이터 로드
            const stops = await loadStops();

            let count = 0;
            let resultHTML = "<h3>5km 내 정차지 목록</h3>";

            for (const stop of stops) {
                const coords = await getCoords(stop.address);
                if (!coords) continue;

                const dist = getDistance(
                    userPos.lat, userPos.lng,
                    coords.lat, coords.lng
                );

                // 반경 5km 이내
                if (dist <= 5) {
                    count++;

                    new kakao.maps.Marker({
                        position: new kakao.maps.LatLng(coords.lat, coords.lng),
                        map: map
                    });

                    resultHTML += `• ${stop.address} (${dist.toFixed(2)} km)<br>`;
                }
            }

            if (count === 0) resultHTML = "<h3>5km 내 정차지가 없습니다.</h3>";

            document.getElementById("result").innerHTML = resultHTML;
        }
    </script>
</body>
</html>
