<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì…”í‹€ë²„ìŠ¤ ì •ì°¨ì§€ ê²€ìƒ‰</title>

    <!-- ì¹´ì¹´ì˜¤ ì§€ë„ SDK (autoload=true ê¸°ë³¸ê°’) -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=e0ed84b38bd53c1a90ebfc15b786cad4&libraries=services"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #map {
            width: 100%;
            height: 400px;
            margin-top: 20px;
            border-radius: 12px;
        }
        #result h3 {
            margin-top: 20px;
            font-size: 18px;
            font-weight: bold;
        }
    </style>
</head>

<body>

<h2>ğŸš ì…”í‹€ë²„ìŠ¤ ì •ì°¨ì§€ ê²€ìƒ‰</h2>

<input id="userAddress" type="text" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="width:80%; padding:10px;">
<button onclick="startSearch()" style="padding:10px 20px;">ê²€ìƒ‰</button>

<div id="result"></div>
<div id="map"></div>


<script>
/* ----------------------
   CSV ì •ë¥˜ì¥ ë°ì´í„° URL
----------------------- */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRKhfocVUTUBOZugwcAROeWqHAZAGA-DzpoE-t8KE3Ahtje4qIvPWu31m5zPfRbU6P2D7Kfw31z03V2/pub?output=csv";

/* ì£¼ì†Œ â†’ ì¢Œí‘œ ë³€í™˜ í•¨ìˆ˜ */
function getCoords(address) {
    return new Promise((resolve, reject) => {
        const geocoder = new kakao.maps.services.Geocoder();

        geocoder.addressSearch(address, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
                resolve({
                    lat: result[0].y,
                    lng: result[0].x
                });
            } else {
                reject("ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨");
            }
        });
    });
}

/* ë‘ ì¢Œí‘œ ì‚¬ì´ ê±°ë¦¬ ê³„ì‚° (km ë‹¨ìœ„) */
function distance(lat1, lng1, lat2, lng2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;

    const a = Math.sin(dLat/2) ** 2 +
              Math.cos(lat1 * Math.PI/180) *
              Math.cos(lat2 * Math.PI/180) *
              Math.sin(dLng/2) ** 2;

    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

/* ----------------------
   ê²€ìƒ‰ ì‹¤í–‰ í•¨ìˆ˜
----------------------- */
async function startSearch() {
    const userAddress = document.getElementById("userAddress").value.trim();
    if (!userAddress) return alert("ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    document.getElementById("result").innerHTML = "<h3>ê²€ìƒ‰ ì¤‘...</h3>";

    // 1) ì‚¬ìš©ì ì£¼ì†Œ ì¢Œí‘œ ë³€í™˜
    let userCoords;
    try {
        userCoords = await getCoords(userAddress);
    } catch (e) {
        document.getElementById("result").innerHTML = "<h3>âŒ ì£¼ì†Œ ê²€ìƒ‰ ì‹¤íŒ¨</h3>";
        return;
    }

    // 2) CSV ë¶ˆëŸ¬ì˜¤ê¸°
    const res = await fetch(CSV_URL);
    const text = await res.text();
    const rows = text.trim().split("\n");

    const parsedStops = rows.map(r => {
        const [address, name] = r.split(",");
        return { address: address.trim(), name: name.trim() };
    });

    let foundList = [];

    // 3) ëª¨ë“  ì •ë¥˜ì¥ ê±°ë¦¬ ê³„ì‚°
    for (let stop of parsedStops) {
        try {
            const coords = await getCoords(stop.address);
            const km = distance(userCoords.lat, userCoords.lng, coords.lat, coords.lng);

            if (km <= 5) {  // ğŸ”¥ ë°˜ê²½ 5km
                foundList.push({
                    name: stop.name,
                    address: stop.address,
                    dist: km,
                    lat: coords.lat,
                    lng: coords.lng
                });
            }
        } catch (e) {}
    }

    // 4) ê²°ê³¼ ì •ë ¬ (ê°€ê¹Œìš´ ìˆœ)
    foundList.sort((a, b) => a.dist - b.dist);

    if (foundList.length === 0) {
        document.getElementById("result").innerHTML = "<h3>âŒ 5km ì´ë‚´ ì •ë¥˜ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</h3>";
        return;
    }

    let html = "<h3>ğŸ“ 5km ì´ë‚´ ì •ë¥˜ì¥</h3>";
    foundList.forEach(s => {
        html += `<p><b>${s.name}</b><br>${s.address}<br>ê±°ë¦¬: ${s.dist.toFixed(2)} km</p>`;
    });

    document.getElementById("result").innerHTML = html;

    // 5) ì§€ë„ í‘œì‹œ
    const map = new kakao.maps.Map(document.getElementById("map"), {
        center: new kakao.maps.LatLng(userCoords.lat, userCoords.lng),
        level: 5
    });

    // ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤
    new kakao.maps.Marker({
        map,
        position: new kakao.maps.LatLng(userCoords.lat, userCoords.lng)
    });

    // ì •ë¥˜ì¥ ë§ˆì»¤
    foundList.forEach(s => {
        new kakao.maps.Marker({
            map,
            position: new kakao.maps.LatLng(s.lat, s.lng)
        });
    });
}
</script>

</body>
</html>
