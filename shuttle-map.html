<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>셔틀버스 정류장 거리 검색</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  #map { width: 100%; height: 450px; margin-top: 20px; border-radius: 12px; }
  .input-wrap {
    display: flex; gap: 10px; margin-bottom: 15px;
  }
  input {
    flex: 1;
    padding: 12px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 8px;
  }
  button {
    padding: 12px 18px;
    font-size: 16px;
    background: #172C8D;
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  #result { margin-top: 20px; font-size: 16px; }
</style>

<!-- Kakao Maps API -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=e0ed84b38bd53c1a90ebfc15b786cad4&libraries=services"></script>

</head>
<body>

<h2>셔틀버스 정차지 검색</h2>

<div class="input-wrap">
  <input id="userAddress" type="text" placeholder="주소를 입력하세요">
  <button onclick="searchAddress()">검색</button>
</div>

<div id="map"></div>
<div id="result"></div>

<script>
// ====== 지도 기본 설정 ======
let map, geocoder, userMarker, circle;

window.onload = function () {
    geocoder = new kakao.maps.services.Geocoder();

    let container = document.getElementById("map");
    map = new kakao.maps.Map(container, {
        center: new kakao.maps.LatLng(37.285, 127.01),
        level: 6,
    });
};

// ====== CSV URL ======
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRKhfocVUTUBOZugwcAROeWqHAZAGA-DzpoE-t8KE3Ahtje4qIvPWu31m5zPfRbU6P2D7Kfw31z03V2/pub?output=csv";

// ====== CSV 데이터 가져오기 ======
async function loadStops() {
    const res = await fetch(CSV_URL);
    const text = await res.text();

    const rows = text.trim().split("\n").slice(1); // header 제거

    return rows.map(r => {
        const [address, name] = r.split(",");
        return { address: address.trim(), name: name.trim() };
    });
}

// ====== 주소 → 좌표 변환 함수 ======
function getCoords(address) {
    return new Promise((resolve) => {
        geocoder.addressSearch(address, function (result, status) {
            if (status === kakao.maps.services.Status.OK) {
                resolve({
                    lat: parseFloat(result[0].y),
                    lng: parseFloat(result[0].x)
                });
            } else {
                resolve(null);
            }
        });
    });
}

// ====== 거리 계산 함수 (Haversine Formula) ======
function getDistance(lat1, lng1, lat2, lng2) {
    const R = 6371; // km
    const dLat = (lat2 - lat1) * (Math.PI / 180);
    const dLng = (lng2 - lng1) * (Math.PI / 180);
    const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(lat1 * Math.PI / 180) *
        Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLng / 2) ** 2;

    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// ====== 메인 검색 함수 ======
async function searchAddress() {
    const input = document.getElementById("userAddress").value.trim();
    if (!input) return alert("주소를 입력해주세요.");

    // 사용자 주소 좌표 변환
    const userPos = await getCoords(input);
    if (!userPos) return alert("주소를 찾을 수 없습니다.");

    // 지도 이동 + 마커 표시
    const userLatLng = new kakao.maps.LatLng(userPos.lat, userPos.lng);
    map.setCenter(userLatLng);

    if (userMarker) userMarker.setMap(null);
    userMarker = new kakao.maps.Marker({
        position: userLatLng,
        map: map
    });

    // 반경 원 표시 (5km = 5000m)
    if (circle) circle.setMap(null);
    circle = new kakao.maps.Circle({
        center: userLatLng,
        radius: 5000,
        strokeWeight: 2,
        strokeColor: "#172C8D",
        fillColor: "#A3B8FF",
        fillOpacity: 0.2
    });
    circle.setMap(map);

    // 정류장 가져오기
    const stops = await loadStops();

    let resultHTML = "<h3>5km 내 정차지</h3>";
    let count = 0;

    for (const stop of stops) {
        const coords = await getCoords(stop.address);
        if (!coords) continue;

        const dist = getDistance(
            userPos.lat, userPos.lng,
            coords.lat, coords.lng
        );

        if (dist <= 5) {
            count++;

            // 마커 표시
            new kakao.maps.Marker({
                position: new kakao.maps.LatLng(coords.lat, coords.lng),
                map: map
            });

            resultHTML += `• ${stop.address} (${dist.toFixed(2)} km)<br>`;
        }
    }

    if (count === 0) {
        resultHTML = "<h3>5km 내 정차지가 없습니다.</h3>";
    }

    document.getElementById("result").innerHTML = resultHTML;
}
</script>

</body>
</html>
